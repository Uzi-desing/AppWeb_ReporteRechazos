{% extends "navegacion.html" %}
{% load static %}

{% block content %}
<div class="w-full max-w-6xl mx-auto mt-8">
    
    <h1 class="text-2xl font-semibold tracking-tight mb-6 text-black/90">
        Registrar Piezas Rechazadas para el Reporte <span class="text-brand font-bold">N°{{ reporte.idReporte }}</span>
    </h1>

    <div class="p-6 rounded-lg border border-black/10 bg-white shadow-md">
        
        <form method="post" enctype="multipart/form-data" id="piezas-form">
            {% csrf_token %}
            {{ formset.management_form }}

            <div class="overflow-x-auto border border-black/10 rounded-lg">
                <table class="w-full text-sm text-left text-black/80">
                    <thead class="text-xs text-white uppercase bg-black/80">
                        <tr>
                            <th scope="col" class="px-3 py-3 font-medium tracking-wider w-1/5">Pieza (Categoría / Medidas)</th>
                            <th scope="col" class="px-3 py-3 font-medium tracking-wider w-1/5">Categoría de Daño</th>
                            <th scope="col" class="px-3 py-3 font-medium tracking-wider w-1/12">Cantidad</th>
                            <th scope="col" class="px-3 py-3 font-medium tracking-wider w-1/4">Observaciones</th>
                            <th scope="col" class="px-3 py-3 font-medium tracking-wider w-1/6">Imagen</th>
                            <th scope="col" class="px-3 py-3 font-medium tracking-wider w-1/12 text-center">Eliminar</th> 
                        </tr>
                    </thead>
                    <tbody id="formset-tbody">
                        {% for form in formset %}
                        <tr class="form-row border-b border-black/10 hover:bg-black/5 transition-colors 
                                   {% if form.DELETE.value %}bg-red-50/50{% endif %}" 
                            data-prefix="{{ form.prefix }}">
                            <td class="px-3 py-2">{{ form.idPieza }}</td>
                            <td class="px-3 py-2">{{ form.idCategoriaDano }}</td>
                            <td class="px-3 py-2">{{ form.cantidad }}</td>
                            <td class="px-3 py-2">{{ form.observaciones }}</td>
                            <td class="px-3 py-2">{{ form.imagen }}</td>
                            <td class="px-3 py-2 text-center delete-cell">
                                {{ form.id }} 
                                
                                {% if form.instance.pk %}
                                    {{ form.DELETE }}
                                    <label for="{{ form.DELETE.id_for_label }}" class="text-xs text-red-600 font-medium ml-1 cursor-pointer">Marcar para eliminar</label>
                                {% else %}
                                    <button type="button" class="inline-flex items-center text-xs px-2 py-1 rounded border border-red-600 text-red-600 hover:bg-red-600 hover:text-white transition-colors remove-row">
                                        <i data-lucide="x" class="w-3 h-3 mr-1"></i>Quitar
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <button type="button" 
                    class="mt-4 inline-flex items-center rounded-md border border-black/50 px-3 py-2 text-sm font-medium text-black hover:bg-brand hover:border-brand hover:text-white transition-colors" 
                    id="add-form-row">
                <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Añadir otra Pieza
            </button>
                    
            <div class="flex justify-end pt-6 border-t border-black/10 mt-6">
                <button type="submit" 
                        class="inline-flex items-center rounded-md bg-brand border border-brand px-5 py-2 text-sm font-medium text-white hover:bg-brand/90 transition-colors shadow-md">
                    <i data-lucide="save" class="w-4 h-4 mr-2"></i> Guardar Piezas
                </button>
            </div>
        </form>
    </div>
</div>

<template id="empty-form-template">
    {% with formset.empty_form as form %}
    <tr class="form-row new-form border-b border-black/10 hover:bg-black/5 transition-colors" data-prefix="__prefix__">
        <td class="px-3 py-2">{{ form.idPieza }}</td>
        <td class="px-3 py-2">{{ form.idCategoriaDano }}</td>
        <td class="px-3 py-2">{{ form.cantidad }}</td>
        <td class="px-3 py-2">{{ form.observaciones }}</td>
        <td class="px-3 py-2">{{ form.imagen }}</td>
        <td class="px-3 py-2 text-center delete-cell">
            {{ form.id }}
            {{ form.DELETE }}
            <button type="button" class="inline-flex items-center text-xs px-2 py-1 rounded border border-red-600 text-red-600 hover:bg-red-600 hover:text-white transition-colors remove-row">
                <i data-lucide="x" class="w-3 h-3 mr-1"></i>Quitar
            </button>
        </td>
    </tr>
    {% endwith %}
</template>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block js %}
    <script src="{% static 'js/crear_pieza_rechazada.js' %}"></script>
{% endblock %}
